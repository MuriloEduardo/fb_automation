{% extends "facebook_integration/base.html" %}
{% load static %}

{% block title %}Insights Avan√ßados - {{ page.name }}{% endblock %}

{% block extra_css %}
<style>
    .insight-card {
        transition: transform 0.2s;
    }
    .insight-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">üìä Insights Avan√ßados</h1>
                    <p class="text-muted">{{ page.name }} - √öltimos {{ days_back }} dias</p>
                </div>
                <div>
                    <div class="btn-group me-2">
                        <a href="?days=7" class="btn btn-sm {% if days_back == 7 %}btn-primary{% else %}btn-outline-primary{% endif %}">7 dias</a>
                        <a href="?days=30" class="btn btn-sm {% if days_back == 30 %}btn-primary{% else %}btn-outline-primary{% endif %}">30 dias</a>
                        <a href="?days=90" class="btn btn-sm {% if days_back == 90 %}btn-primary{% else %}btn-outline-primary{% endif %}">90 dias</a>
                    </div>
                    <a href="{% url 'facebook_integration:page_detail' page.id %}" class="btn btn-secondary btn-sm">
                        ‚Üê Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    {% if insights.summary %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card insight-card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Total de F√£s</h6>
                    <h2 class="text-primary">{{ insights.summary.total_fans|default:"0"|floatformat:0 }}</h2>
                    <small class="text-success">
                        +{{ insights.summary.new_fans|default:"0" }} 
                        <span class="text-danger">-{{ insights.summary.lost_fans|default:"0" }}</span>
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card insight-card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Impress√µes Totais</h6>
                    <h2 class="text-info">{{ insights.summary.total_impressions|default:"0"|floatformat:0 }}</h2>
                    <small class="text-muted">
                        Org: {{ insights.summary.organic_impressions|default:"0"|floatformat:0 }} | 
                        Pagas: {{ insights.summary.paid_impressions|default:"0"|floatformat:0 }}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card insight-card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Impress√µes Virais</h6>
                    <h2 class="text-warning">{{ insights.summary.viral_impressions|default:"0"|floatformat:0 }}</h2>
                    <small class="text-muted">alcance viral</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card insight-card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Usu√°rios Engajados</h6>
                    <h2 class="text-success">{{ insights.summary.engaged_users|default:"0"|floatformat:0 }}</h2>
                    <small class="text-muted">engajamento</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Demographics Section -->
    {% if insights.demographics.demographics %}
    <div class="row mb-4">
        <!-- Gender Distribution -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üë• Distribui√ß√£o por G√™nero</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="genderChart"></canvas>
                    </div>
                    {% if insights.summary.gender_distribution %}
                    <div class="mt-3 text-center">
                        <span class="badge bg-primary me-2">
                            Masculino: {{ insights.summary.gender_distribution.male_percentage }}%
                        </span>
                        <span class="badge bg-danger">
                            Feminino: {{ insights.summary.gender_distribution.female_percentage|add:"-100"|floatformat:1|cut:"-" }}%
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Age Distribution -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä Distribui√ß√£o por Idade</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Section -->
    <div class="row mb-4">
        <!-- Top Countries -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üåé Top Pa√≠ses</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="countriesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Cities -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üèôÔ∏è Top Cidades</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="citiesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Reach Breakdown -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìà Alcance por Tipo</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="reachChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Engagement Metrics -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üí¨ M√©tricas de Engajamento</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if insights.engagement.insights.page_engaged_users.latest_value %}
                        <div class="col-md-4">
                            <h6>Usu√°rios Engajados</h6>
                            <p class="h4">{{ insights.engagement.insights.page_engaged_users.latest_value|floatformat:0 }}</p>
                        </div>
                        {% endif %}
                        {% if insights.engagement.insights.page_post_engagements.latest_value %}
                        <div class="col-md-4">
                            <h6>Engajamentos em Posts</h6>
                            <p class="h4">{{ insights.engagement.insights.page_post_engagements.latest_value|floatformat:0 }}</p>
                        </div>
                        {% endif %}
                        {% if insights.engagement.insights.page_actions_post_reactions_total.latest_value %}
                        <div class="col-md-4">
                            <h6>Total de Rea√ß√µes</h6>
                            <p class="h4">{{ insights.engagement.insights.page_actions_post_reactions_total.latest_value|floatformat:0 }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const insights = {{ insights|safe }};
    
    // Gender Chart
    {% if insights.demographics.demographics.gender_age %}
    const genderData = insights.demographics.demographics.gender_age;
    const maleTotal = Object.values(genderData.male || {}).reduce((a, b) => a + b, 0);
    const femaleTotal = Object.values(genderData.female || {}).reduce((a, b) => a + b, 0);
    
    new Chart(document.getElementById('genderChart'), {
        type: 'doughnut',
        data: {
            labels: ['Masculino', 'Feminino'],
            datasets: [{
                data: [maleTotal, femaleTotal],
                backgroundColor: ['#0d6efd', '#dc3545'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
    
    // Age Distribution Chart
    const ageRanges = {};
    Object.keys(genderData.male || {}).forEach(range => {
        ageRanges[range] = (genderData.male[range] || 0) + (genderData.female[range] || 0);
    });
    
    new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(ageRanges),
            datasets: [{
                label: 'Total de F√£s',
                data: Object.values(ageRanges),
                backgroundColor: '#0d6efd',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false,
                }
            }
        }
    });
    {% endif %}
    
    // Countries Chart
    {% if insights.demographics.demographics.countries %}
    const countries = insights.demographics.demographics.countries;
    new Chart(document.getElementById('countriesChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(countries),
            datasets: [{
                label: 'F√£s por Pa√≠s',
                data: Object.values(countries),
                backgroundColor: '#198754',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
        }
    });
    {% endif %}
    
    // Cities Chart
    {% if insights.demographics.demographics.cities %}
    const cities = insights.demographics.demographics.cities;
    new Chart(document.getElementById('citiesChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(cities),
            datasets: [{
                label: 'F√£s por Cidade',
                data: Object.values(cities),
                backgroundColor: '#ffc107',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
        }
    });
    {% endif %}
    
    // Reach Chart
    {% if insights.summary %}
    new Chart(document.getElementById('reachChart'), {
        type: 'bar',
        data: {
            labels: ['Org√¢nica', 'Paga', 'Viral'],
            datasets: [{
                label: 'Impress√µes',
                data: [
                    {{ insights.summary.organic_impressions|default:"0" }},
                    {{ insights.summary.paid_impressions|default:"0" }},
                    {{ insights.summary.viral_impressions|default:"0" }}
                ],
                backgroundColor: ['#198754', '#0d6efd', '#ffc107'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
        }
    });
    {% endif %}
});
</script>
{% endblock %}
