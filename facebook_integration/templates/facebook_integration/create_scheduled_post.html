{% extends 'facebook_integration/base.html' %}

{% block title %}
  Criar Post Agendado - Facebook Automation
{% endblock %}

{% block page_title %}
  Criar Post Agendado
{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body">
          <form method="post" id="post-form">
            {% csrf_token %}

            <!-- Tipo de postagem -->
            <div class="mb-3">
              <label class="form-label">Tipo de Postagem</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="post_type" id="immediate" value="immediate" checked />
                <label class="btn btn-outline-primary" for="immediate">Publicar Agora</label>

                <input type="radio" class="btn-check" name="post_type" id="scheduled" value="scheduled" />
                <label class="btn btn-outline-secondary" for="scheduled">Agendar</label>
              </div>
            </div>

            <!-- Seleção de páginas -->
            <div class="mb-3">
              <label for="facebook_pages" class="form-label">Páginas do Facebook</label>
              <div class="border p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="select_all_pages" />
                  <label class="form-check-label fw-bold" for="select_all_pages">Selecionar Todas</label>
                </div>
                <hr />
                {% for page in facebook_pages %}
                  <div class="form-check">
                    <input class="form-check-input page-checkbox" type="checkbox" name="facebook_pages" value="{{ page.id }}" id="page_{{ page.id }}" />
                    <label class="form-check-label" for="page_{{ page.id }}">
                      {{ page.name }}
                      {% if not page.can_publish %}
                        <span class="badge bg-warning text-dark">Sem permissão</span>
                      {% endif %}
                    </label>
                  </div>
                {% endfor %}
              </div>
              <small class="form-text text-muted">Selecione uma ou mais páginas para publicar</small>
            </div>

            <!-- Template -->
            <div class="mb-3">
              <label for="template" class="form-label">Template (opcional)</label>
              <select class="form-select" id="template" name="template">
                <option value="">Nenhum template - escrever manualmente</option>
                {% for template in templates %}
                  <option value="{{ template.id }}">{{ template.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Conteúdo -->
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label for="content" class="form-label mb-0">Conteúdo do Post</label>
                <button type="button" class="btn btn-outline-info btn-sm" id="generate-ai-btn"><i class="bi bi-magic"></i> Gerar com IA</button>
              </div>
              <textarea class="form-control" id="content" name="content" rows="8" placeholder="Digite o conteúdo do post...&#10;&#10;Dicas:&#10;- Use **texto** para negrito&#10;- Use *texto* para itálico&#10;- Use # para títulos&#10;- Use - para listas"></textarea>

              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="use_markdown" name="use_markdown" />
                <label class="form-check-label" for="use_markdown">
                  Processar como Markdown
                  <small class="text-muted">(converte **negrito**, *itálico*, etc.)</small>
                </label>
              </div>
            </div>

            <!-- Imagem -->
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0">Imagem do Post</label>
                <button type="button" class="btn btn-outline-success btn-sm" id="generate-image-btn" disabled><i class="bi bi-image"></i> Gerar Imagem</button>
              </div>
              <input type="hidden" id="image_path" name="image_path" />
              <div id="image-preview" class="border rounded p-3 text-center" style="min-height: 150px; display: none;">
                <img id="preview-img" src="" alt="Preview" class="img-fluid" style="max-height: 300px;" />
                <div class="mt-2">
                  <button type="button" class="btn btn-sm btn-danger" id="remove-image-btn"><i class="bi bi-trash"></i> Remover</button>
                </div>
              </div>
              <div id="image-placeholder" class="border rounded p-3 text-center text-muted" style="min-height: 150px;">
                <i class="bi bi-image" style="font-size: 3rem;"></i>
                <p class="mt-2">Nenhuma imagem gerada</p>
                <small>Escreva o conteúdo e clique em "Gerar Imagem"</small>
              </div>
              <div id="image-loading" class="border rounded p-3 text-center" style="min-height: 150px; display: none;">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">Gerando...</span>
                </div>
                <p class="mt-2">Gerando imagem com IA...</p>
              </div>
            </div>

            <!-- Data e hora (apenas para agendados) -->
            <div class="mb-3" id="datetime-group" style="display: none;">
              <label for="scheduled_time" class="form-label">Data e Hora para Publicação</label>
              <input type="datetime-local" class="form-control" id="scheduled_time" name="scheduled_time" />
            </div>

            <div class="d-flex justify-content-between">
              <a href="{% url 'facebook_integration:scheduled_posts' %}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Voltar</a>
              <div>
                <button type="button" class="btn btn-outline-primary me-2" id="preview-btn"><i class="bi bi-eye"></i> Pré-visualizar</button>
                <button type="submit" class="btn btn-primary" id="submit-btn"><i class="bi bi-send"></i> <span id="submit-text">Publicar Agora</span></button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de prévia -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pré-visualização do Post</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="preview-content">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Digite o conteúdo para ver a prévia
            </div>
          </div>
          <div id="selected-pages-preview" class="mt-3">
            <h6>Páginas Selecionadas:</h6>
            <ul id="pages-list"></ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de progresso -->
  <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-cloud-upload"></i> Processando Publicação</h5>
        </div>
        <div class="modal-body">
          <div class="progress mb-3">
            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
          <p id="progress-status">Iniciando...</p>
          <div id="progress-details"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para geração automática de conteúdo com IA -->
  <div class="modal fade" id="aiGenerateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gerar Conteúdo Inteligente com IA</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle"></i>
            A IA vai analisar as páginas selecionadas e gerar conteúdo personalizado baseado nas características de cada uma.
          </p>

          <div id="selected-pages-info" class="mb-3">
            <small class="text-muted">Selecione pelo menos uma página para gerar conteúdo</small>
          </div>

          <div class="mb-3">
            <label for="content-type" class="form-label">Tipo de Conteúdo:</label>
            <select class="form-select" id="content-type">
              <option value="promotional">Promocional</option>
              <option value="informative">Informativo</option>
              <option value="engaging">Engajamento</option>
              <option value="news">Notícias</option>
              <option value="behind-scenes">Bastidores</option>
              <option value="educational">Educativo</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="content-tone" class="form-label">Tom de Voz:</label>
            <select class="form-select" id="content-tone">
              <option value="professional">Profissional</option>
              <option value="friendly">Amigável</option>
              <option value="casual">Casual</option>
              <option value="formal">Formal</option>
              <option value="enthusiastic">Entusiasmado</option>
              <option value="inspirational">Inspiracional</option>
            </select>
          </div>

          <div id="ai-loading" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Gerando...</span>
            </div>
            <p class="mt-2">Analisando páginas e gerando conteúdo personalizado...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="generate-ai-content-btn"><i class="bi bi-magic"></i> Gerar Conteúdo Inteligente</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const postTypeInputs = document.querySelectorAll('input[name="post_type"]')
      const datetimeGroup = document.getElementById('datetime-group')
      const submitText = document.getElementById('submit-text')
      const scheduledTimeInput = document.getElementById('scheduled_time')
      const selectAllCheckbox = document.getElementById('select_all_pages')
      const pageCheckboxes = document.querySelectorAll('.page-checkbox')
      const previewBtn = document.getElementById('preview-btn')
      const form = document.getElementById('post-form')
    
      // Controlar exibição do campo de data/hora
      postTypeInputs.forEach((input) => {
        input.addEventListener('change', function () {
          if (this.value === 'scheduled') {
            datetimeGroup.style.display = 'block'
            submitText.textContent = 'Agendar Posts'
            scheduledTimeInput.required = true
          } else {
            datetimeGroup.style.display = 'none'
            submitText.textContent = 'Publicar Agora'
            scheduledTimeInput.required = false
          }
        })
      })
    
      // Selecionar/deselecionar todas as páginas
      selectAllCheckbox.addEventListener('change', function () {
        pageCheckboxes.forEach((checkbox) => {
          checkbox.checked = this.checked
        })
      })
    
      // Atualizar "selecionar todas" baseado nos checkboxes individuais
      pageCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', function () {
          const checkedCount = document.querySelectorAll('.page-checkbox:checked').length
          selectAllCheckbox.checked = checkedCount === pageCheckboxes.length
          selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < pageCheckboxes.length
        })
      })
    
      // Pré-visualização
      previewBtn.addEventListener('click', function () {
        const content = document.getElementById('content').value
        const useMarkdown = document.getElementById('use_markdown').checked
        const selectedPages = Array.from(document.querySelectorAll('.page-checkbox:checked')).map((cb) => cb.nextElementSibling.textContent.trim())
    
        // Mostrar conteúdo
        let previewHtml = ''
        if (content.trim()) {
          if (useMarkdown) {
            // Simular conversão básica de markdown
            previewHtml = content
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
              .replace(/\*(.*?)\*/g, '<em>$1</em>')
              .replace(/\n/g, '<br>')
          } else {
            previewHtml = content.replace(/\n/g, '<br>')
          }
          document.getElementById('preview-content').innerHTML = '<div class="card"><div class="card-body">' + previewHtml + '</div></div>'
        } else {
          document.getElementById('preview-content').innerHTML = '<div class="alert alert-warning">Nenhum conteúdo inserido</div>'
        }
    
        // Mostrar páginas selecionadas
        const pagesList = document.getElementById('pages-list')
        pagesList.innerHTML = ''
        if (selectedPages.length > 0) {
          selectedPages.forEach((page) => {
            const li = document.createElement('li')
            li.textContent = page
            pagesList.appendChild(li)
          })
        } else {
          pagesList.innerHTML = '<li class="text-warning">Nenhuma página selecionada</li>'
        }
    
        // Mostrar modal
        new bootstrap.Modal(document.getElementById('previewModal')).show()
      })
    
      // Envio do formulário
      form.addEventListener('submit', function (e) {
        e.preventDefault()
    
        // Validar seleção de páginas
        const selectedPages = document.querySelectorAll('.page-checkbox:checked')
        if (selectedPages.length === 0) {
          alert('Selecione pelo menos uma página para publicar.')
          return
        }
    
        // Validar conteúdo
        const content = document.getElementById('content').value.trim()
        const template = document.getElementById('template').value
        if (!content && !template) {
          alert('Digite o conteúdo do post ou selecione um template.')
          return
        }
    
        // Mostrar modal de progresso
        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'))
        progressModal.show()
    
        // Preparar dados
        const formData = new FormData(form)
    
        // Enviar via AJAX
        fetch(form.action || window.location.href, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`)
            }
            return response.json()
          })
          .then((data) => {
            if (data.success) {
              if (data.task_id) {
                // Monitorar progresso da task
                checkTaskProgress(data.task_id)
              } else {
                // Sucesso imediato
                progressModal.hide()
                window.location.href = data.redirect_url || '{% url "facebook_integration:scheduled_posts" %}'
              }
            } else {
              progressModal.hide()
              alert('Erro: ' + data.error)
            }
          })
          .catch((error) => {
            progressModal.hide()
            alert('Erro de conexão: ' + error.message)
          })
      })
    
      function checkTaskProgress(taskId) {
        const progressBar = document.querySelector('.progress-bar')
        const progressStatus = document.getElementById('progress-status')
        const progressDetails = document.getElementById('progress-details')
    
        function updateProgress() {
          fetch(`{% url 'facebook_integration:task_status' 'PLACEHOLDER' %}`.replace('PLACEHOLDER', taskId), {
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.state === 'PROGRESS') {
                const percent = Math.round((data.current / data.total) * 100)
                progressBar.style.width = percent + '%'
                progressBar.textContent = percent + '%'
                progressStatus.textContent = data.status
    
                setTimeout(updateProgress, 1000)
              } else if (data.state === 'SUCCESS') {
                progressBar.style.width = '100%'
                progressBar.textContent = '100%'
                progressStatus.textContent = 'Concluído!'
    
                // Mostrar resultados
                let resultsHtml = '<h6>Resultados:</h6>'
                if (data.result.success.length > 0) {
                  resultsHtml += `<p class="text-success">${data.result.success.length} páginas publicadas com sucesso</p>`
                }
                if (data.result.failed.length > 0) {
                  resultsHtml += `<p class="text-danger">${data.result.failed.length} páginas falharam</p>`
                }
                progressDetails.innerHTML = resultsHtml
    
                setTimeout(() => {
                  window.location.href = '{% url "facebook_integration:scheduled_posts" %}'
                }, 3000)
              } else if (data.state === 'FAILURE') {
                progressStatus.textContent = 'Erro: ' + data.result
                progressBar.classList.add('bg-danger')
              }
            })
            .catch((error) => {
              progressStatus.textContent = 'Erro de conexão'
              progressBar.classList.add('bg-danger')
            })
        }
    
        updateProgress()
      }
    })
    
    // Funcionalidade de geração de conteúdo com IA
    const generateAiBtn = document.getElementById('generate-ai-btn')
    const aiModal = new bootstrap.Modal(document.getElementById('aiGenerateModal'))
    const generateAiContentBtn = document.getElementById('generate-ai-content-btn')
    const aiLoading = document.getElementById('ai-loading')
    const selectedPagesInfo = document.getElementById('selected-pages-info')
    const contentType = document.getElementById('content-type')
    const contentTone = document.getElementById('content-tone')
    
    // Função para atualizar informações das páginas selecionadas
    function updateSelectedPagesInfo() {
      const selectedPages = Array.from(document.querySelectorAll('.page-checkbox:checked'))
      const selectedPagesInfo = document.getElementById('selected-pages-info')
    
      if (selectedPages.length === 0) {
        selectedPagesInfo.innerHTML = '<small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Selecione pelo menos uma página para gerar conteúdo</small>'
        document.getElementById('generate-ai-content-btn').disabled = true
      } else {
        const pageNames = selectedPages.map((checkbox) => {
          const label = document.querySelector(`label[for="${checkbox.id}"]`)
          return label.textContent.trim().split('\n')[0] // Remove badges
        })
    
        selectedPagesInfo.innerHTML = `
                      <div class="alert alert-info p-2 mb-0">
                        <strong><i class="bi bi-facebook"></i> Páginas selecionadas (${selectedPages.length}):</strong><br>
                        <small>${pageNames.join(', ')}</small>
                      </div>
                    `
        document.getElementById('generate-ai-content-btn').disabled = false
      }
    }
    
    // Atualizar info quando modal abrir
    generateAiBtn.addEventListener('click', function () {
      updateSelectedPagesInfo()
      aiModal.show()
    })
    
    // Atualizar info quando checkboxes mudarem
    document.addEventListener('change', function (e) {
      if (e.target.classList.contains('page-checkbox') || e.target.id === 'select_all_pages') {
        updateSelectedPagesInfo()
      }
    })
    
    generateAiContentBtn.addEventListener('click', function () {
      const selectedPages = Array.from(document.querySelectorAll('.page-checkbox:checked'))
    
      if (selectedPages.length === 0) {
        alert('Por favor, selecione pelo menos uma página')
        return
      }
    
      // Coletar informações das páginas selecionadas
      const pagesData = selectedPages.map((checkbox) => {
        const label = document.querySelector(`label[for="${checkbox.id}"]`)
        const pageName = label.textContent.trim().split('\n')[0]
        return {
          id: checkbox.value,
          name: pageName
        }
      })
    
      const selectedTemplate = document.getElementById('template').value
    
      // Mostrar loading
      aiLoading.style.display = 'block'
      generateAiContentBtn.disabled = true
    
      // Enviar requisição para gerar conteúdo inteligente
      fetch('{% url "facebook_integration:generate_intelligent_content" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          pages: pagesData,
          content_type: contentType.value,
          content_tone: contentTone.value,
          template_id: selectedTemplate || null
        })
      })
        .then((response) => response.json())
        .then((data) => {
          aiLoading.style.display = 'none'
          generateAiContentBtn.disabled = false
    
          if (data.success) {
            // Inserir conteúdo gerado no textarea
            document.getElementById('content').value = data.content
            aiModal.hide()
            alert('Conteúdo inteligente gerado com sucesso!')
          } else {
            alert('Erro ao gerar conteúdo: ' + data.error)
          }
        })
        .catch((error) => {
          aiLoading.style.display = 'none'
          generateAiContentBtn.disabled = false
          console.error('Erro:', error)
          alert('Erro ao gerar conteúdo com IA')
        })
    })

    // Funcionalidade de geração de imagem
    const generateImageBtn = document.getElementById('generate-image-btn')
    const contentTextarea = document.getElementById('content')
    const imagePreview = document.getElementById('image-preview')
    const imagePlaceholder = document.getElementById('image-placeholder')
    const imageLoading = document.getElementById('image-loading')
    const previewImg = document.getElementById('preview-img')
    const imagePathInput = document.getElementById('image_path')
    const removeImageBtn = document.getElementById('remove-image-btn')

    contentTextarea.addEventListener('input', function () {
      if (this.value.trim().length > 10) {
        generateImageBtn.disabled = false
      } else {
        generateImageBtn.disabled = true
      }
    })

    generateImageBtn.addEventListener('click', function () {
      const content = contentTextarea.value.trim()
      if (!content) {
        alert('Digite o conteúdo do post antes de gerar a imagem')
        return
      }

      imagePlaceholder.style.display = 'none'
      imagePreview.style.display = 'none'
      imageLoading.style.display = 'block'
      generateImageBtn.disabled = true

      fetch('{% url "facebook_integration:generate_image" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          content: content
        })
      })
        .then((response) => response.json())
        .then((data) => {
          imageLoading.style.display = 'none'
          generateImageBtn.disabled = false

          if (data.success) {
            imagePathInput.value = data.image_path
            previewImg.src = data.image_url
            imagePreview.style.display = 'block'
            imagePlaceholder.style.display = 'none'
          } else {
            alert('Erro ao gerar imagem: ' + data.error)
            imagePlaceholder.style.display = 'block'
          }
        })
        .catch((error) => {
          imageLoading.style.display = 'none'
          generateImageBtn.disabled = false
          imagePlaceholder.style.display = 'block'
          console.error('Erro:', error)
          alert('Erro ao gerar imagem')
        })
    })

    removeImageBtn.addEventListener('click', function () {
      imagePathInput.value = ''
      previewImg.src = ''
      imagePreview.style.display = 'none'
      imagePlaceholder.style.display = 'block'
    })
  </script>
{% endblock %}
