{% extends 'base.html' %}
{% load static %}

{% block title %}
  Fila de Aprovação - Facebook Automation
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="row">
      <div class="col-12">
        <h1 class="mb-4">
          <i class="fas fa-check-circle"></i> Fila de Aprovação{% if total_pending > 0 %}
            <span class="badge bg-warning text-dark">{{ total_pending }}</span>
          {% endif %}
        </h1>
      </div>
    </div>

    {% if messages %}
      <div class="row">
        <div class="col-12">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if pending_posts %}
      <div class="row">
        {% for post in pending_posts %}
          <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0"><i class="fas fa-clock"></i> {{ post.facebook_page.name }}</h5>
              </div>
              <div class="card-body">
                <p class="text-muted small">
                  <i class="fas fa-user"></i> Por: {{ post.created_by.username }}<br />
                  <i class="fas fa-calendar"></i> Agendado: {{ post.scheduled_time|date:'d/m/Y H:i' }}<br />
                  <i class="fas fa-plus"></i> Criado: {{ post.created_at|date:'d/m/Y H:i' }}
                </p>

                {% if post.template %}
                  <p class="badge bg-info text-dark">
                    <i class="fas fa-file-alt"></i> Template: {{ post.template.name }}
                  </p>
                {% endif %}

                <div class="post-content mt-3">
                  <h6>Conteúdo:</h6>
                  <div class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">{{ post.generated_content|default:post.content|truncatewords:50 }}</div>
                </div>

                {% if post.generated_image_file %}
                  <div class="mt-2">
                    <img src="{{ post.generated_image_file.url }}" class="img-fluid rounded" alt="Imagem do post" style="max-height: 150px;" />
                  </div>
                {% endif %}
              </div>
              <div class="card-footer">
                <div class="btn-group w-100" role="group">
                  <a href="{% url 'facebook_integration:preview_post' post.id %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i> Preview</a>
                  <form method="post" action="{% url 'facebook_integration:approve_post' post.id %}" class="d-inline" onsubmit="return confirm('Aprovar este post?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success"><i class="fas fa-check"></i> Aprovar</button>
                  </form>
                  <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal{{ post.id }}"><i class="fas fa-times"></i> Rejeitar</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal de Rejeição -->
          <div class="modal fade" id="rejectModal{{ post.id }}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Rejeitar Post</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="{% url 'facebook_integration:reject_post' post.id %}">
                  {% csrf_token %}
                  <div class="modal-body">
                    <div class="mb-3">
                      <label for="rejection_reason{{ post.id }}" class="form-label">Motivo da Rejeição *</label>
                      <textarea class="form-control" id="rejection_reason{{ post.id }}" name="rejection_reason" rows="3" required placeholder="Ex: Conteúdo inadequado, erro gramatical, etc."></textarea>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger"><i class="fas fa-times"></i> Rejeitar Post</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="row">
        <div class="col-12">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Não há posts aguardando aprovação no momento.
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
  <script>
// Auto-refresh a cada 30 segundos se houver posts pendentes
{% if total_pending > 0 %}
setTimeout(function() {
    location.reload();
}, 30000);
{% endif %}
</script>
{% endblock %}
